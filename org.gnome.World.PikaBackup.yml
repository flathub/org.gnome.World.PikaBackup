app-id: org.gnome.World.PikaBackup
command: pika-backup
runtime: org.gnome.Platform
runtime-version: '40'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin

finish-args:
  - --filesystem=host
  # flatpak puts a tmpfs here to hide other apps
  - --filesystem=~/.var/app/
  # sftp mounts etc.
  - --share=network
  - --socket=wayland
  # X11
  - --share=ipc
  - --socket=fallback-x11
  # SSH-keys etc
  - --socket=ssh-auth
  # secrete service (keyring)
  - --talk-name=org.freedesktop.secrets
  # GVfs (gio::Device etc)
  - --talk-name=org.gtk.vfs
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  # fusermount
  - --device=all
  - --talk-name=org.freedesktop.Flatpak.*
  # inhibit shutdown and sleep
  - --system-talk-name=org.freedesktop.login1
  # open folder in filebrowser, work around buggy OpenURI portal
  # https://gitlab.gnome.org/World/pika-backup/-/issues/19
  - --talk-name=org.freedesktop.FileManager1
  # see https://github.com/flatpak/flatpak/issues/4280
  - --unset-env=LD_PRELOAD
modules:

  - name: borg
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=. --prefix=/app setuptools_scm
      - pip3 install --no-index --find-links=. --prefix=/app borgbackup
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/54/85/514ba3ca2a022bddd68819f187ae826986051d130ec5b972076e4f58a9f3/setuptools_scm-3.2.0.tar.gz
        sha256: 52ab47715fa0fc7d8e6cd15168d1a69ba995feb1505131c3e814eb7087b57358
        x-checker-data:
          type: pypi
          name: setuptools_scm
          versions: {<: '3.3'}
      - type: file
        url: https://files.pythonhosted.org/packages/1e/00/05f51ceab8d3b9be4295000d8be4c830c53e5477755888994e9825606cd9/setuptools-58.5.3.tar.gz
        sha256: dae6b934a965c8a59d6d230d3867ec408bb95e73bd538ff77e71fedf1eaca729
        x-checker-data:
          type: pypi
          name: setuptools
      - type: file
        url: https://files.pythonhosted.org/packages/4e/be/8139f127b4db2f79c8b117c80af56a3078cc4824b5b94250c7f81a70e03b/wheel-0.37.0.tar.gz
        sha256: e2ef7239991699e3355d54f8e968a21bb940a1dbf34a4d226741e64462516fad
        x-checker-data:
          type: pypi
          name: wheel
      - type: file
        url: https://files.pythonhosted.org/packages/bf/6f/509e501ff67a335186c8adcdc3ee62195919731b22796b0690658a76bb6f/pyparsing-3.0.4.tar.gz
        sha256: e0df773d7fa2240322daae7805626dfc5f2d5effb34e1a7be2702c99cfb9f6b1
        x-checker-data:
          type: pypi
          name: pyparsing
      - type: file
        url: https://files.pythonhosted.org/packages/4d/34/523195b783e799fd401ad4bbc40d787926dd4c61838441df08bf42297792/packaging-21.2.tar.gz
        sha256: 096d689d78ca690e4cd8a89568ba06d07ca097e3306a4381635073ca91479966
        x-checker-data:
          type: pypi
          name: packaging
      - type: file
        url: https://files.pythonhosted.org/packages/c9/a8/7ce46b3ea57895164774644164089b63e0172ac72046f5fbbba5f135d7bb/borgbackup-1.1.17.tar.gz
        sha256: 7ab924fc017b24929bedceba0dcce16d56f9868bf9b5050d2aae2eb080671674
        x-checker-data:
          type: pypi
          name: borgbackup
          versions: {<: 1.1.99}

  - name: fusermout
    config-opts:
      - MOUNT_FUSE_PATH=/app/bin
    post-install:
      - install fusermount-wrapper.sh /app/bin/fusermount
    sources:
      - type: archive
        url: https://github.com/libfuse/libfuse/releases/download/fuse-2.9.9/fuse-2.9.9.tar.gz
        sha256: d0e69d5d608cc22ff4843791ad097f554dd32540ddc9bed7638cc6fea7c1b4b5
        x-checker-data:
          type: anitya
          project-id: 861
          url-template: https://github.com/libfuse/libfuse/releases/download/fuse-$version/fuse-$version.tar.gz
          versions: {<: '3'}
      - type: patch
        path: fuse-2.9.2-namespace-conflict-fix.patch
      - type: file
        path: fusermount-wrapper.sh

  - name: llfuse
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links=. --prefix=/app llfuse
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b1/d4/44443fbaac6d5b878da99e7c0948ee93c7934fa3b00e48c5363823b583d0/llfuse-1.4.1.tar.gz
        sha256: c29c79d96a5aeab51608cae12594a1bf83576d86232f97341c7f779d413a4ec9
        x-checker-data:
          type: pypi
          name: llfuse
          versions: {<: '1.5'}

  - name: pika-backup
    buildsystem: meson
    config-opts:
      - -Dprofile=release
    sources:
      - type: git
        url: https://gitlab.gnome.org/World/pika-backup.git
        tag: v0.3.5
        commit: df4d93559a79672ca8a4af4750b855012a1c3516
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: file
        path: cargo-config.toml
        dest: .cargo
        dest-filename: config
      # generated via flatpak-builder-tools
      - generated-sources.json

